@using Prog3A25_AntoineTommy_Blazor.Models
@using Prog3A25_AntoineTommy_Blazor.Services
@inject EditWikiService editWikiService
@inject NavigationManager navManager

<title>@titre</title>
<div class="d-flex flex-column justify-content-center align-items-center vh-100" style="margin-top: -80px;">
    <h1 class="mb-4">@titre</h1>
    <div class="card shadow p-4" style="max-width: 700px; width: 100%;">
        @if (editWikiModel != null)
        {
            <EditForm Model="@editWikiModel" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="mb-3">
                    <label for="nom" class="form-label">Nom:</label>
                    <InputText id="nom" class="form-control" @bind-Value="editWikiModel.Nom" placeholder="Cactus" />
                </div>

                <div class="mb-3">
                    <label for="lien" class="form-label">Lien de l'image:</label>
                    <InputText id="lien" class="form-control" @bind-Value="editWikiModel.LienImage" placeholder="https://www.lien.com" />
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Description:</label>
                    <InputTextArea id="description" class="form-control" @bind-Value="editWikiModel.Description"
                                   placeholder="Plante du désert..." rows="5" style="resize: vertical;" />
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Température:</label>
                        <div class="d-flex align-items-center gap-2">
                            <InputNumber class="form-control" @bind-Value="editWikiModel.TempMin" />
                            <span>à</span>
                            <InputNumber class="form-control" @bind-Value="editWikiModel.TempMax" />
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Humidité:</label>
                        <div class="d-flex align-items-center gap-2">
                            <InputNumber class="form-control" @bind-Value="editWikiModel.HumiditeMin" />
                            <span>à</span>
                            <InputNumber class="form-control" @bind-Value="editWikiModel.HumiditeMax" />
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Rayons UV:</label>
                        <div class="d-flex align-items-center gap-2">
                            <InputNumber class="form-control" @bind-Value="editWikiModel.RayonsUVMin" />
                            <span>à</span>
                            <InputNumber class="form-control" @bind-Value="editWikiModel.RayonsUVMax" />
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" @onclick="ResetOnClick" class="btn btn-danger flex-fill">Réinitialiser</button>
                    @if (id != 0)
                    {
                        <button type="button" @onclick="() => showDeleteConfirmation = true" class="btn btn-outline-danger flex-fill">
                            Supprimer le wiki
                        </button>
                    }

                    <button type="submit" class="btn btn-primary flex-fill">@texteBouton</button>
                </div>

            </EditForm>
            @if (showDeleteConfirmation)
            {
                <div class="modal-backdrop fade show"></div>
                <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirmation</h5>
                                <button type="button" class="btn-close" @onclick="() => showDeleteConfirmation = false"></button>
                            </div>
                            <div class="modal-body">
                                <p>Voulez-vous vraiment supprimer ce wiki ? Cette action est irréversible.</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" @onclick="() => showDeleteConfirmation = false">Annuler</button>
                                <button class="btn btn-danger" @onclick="SupprimerWiki">Supprimer</button>
                            </div>
                        </div>
                    </div>
                </div>
            }

        }
        else
        {
            <p>Chargement...</p>
        }
        @((MarkupString)info)
    </div>
</div>

@code {
    [Parameter] public int id { get; set; } = 0;
    public EditWikiModel editWikiModel = new();
    private string info = "";
    private string titre = "Créer un wiki";
    private string texteBouton = "Créer le wiki";
    private bool showDeleteConfirmation = false;

    private async void SupprimerWiki()
    {
        await editWikiService.SupprimerWiki(id);
        navManager.NavigateTo("/Wiki");
    }

    protected override async Task OnInitializedAsync()
    {
        if (id != 0)
        {
            var model = await editWikiService.GetModel(id);
            if (model == null)
            {
                navManager.NavigateTo("/Wiki");
                return;
            }

            editWikiModel = model;
            titre = "Modification de " + editWikiModel.Nom;
            texteBouton = "Modifier le wiki";
        }
        else
            editWikiModel = new EditWikiModel();
    }


    private async Task HandleSubmit()
    {
        int resultat = 0;
        if (id == 0)
            resultat = await editWikiService.CreerWiki(editWikiModel);
        else
            resultat = await editWikiService.ModifierWiki(editWikiModel, id);

        if (resultat == -1)
            info = "<p class='alert alert-danger mt-3'>Veuillez remplir tous les champs.</p>";
        else if (resultat == -2)
            info = "<p class='alert alert-danger mt-3'>Veuillez fournir des barèmes de données valides.</p>";
        else if (resultat == -3)
            info = "<p class='alert alert-danger mt-3'>Veuillez fournir un lien d'image valide.</p>";
        else if (resultat == -4)
            navManager.NavigateTo("/Wiki");
        else if (resultat == -5)
            info = "<p class='alert alert-danger mt-3'>Description trop longue</p>";
        else if (resultat == -6)
            info = "<p class='alert alert-danger mt-3'>Nom trop long</p>";
        else if (resultat == -7)
            info = "<p class='alert alert-danger mt-3'>Lien d'image trop long</p>";
        else
        {
            info = "";
            navManager.NavigateTo("/Wiki/" + resultat);
        }
    }

    private async void ResetOnClick()
    {
        if (id != 0)
            editWikiModel = await editWikiService.GetModel(id);
        else
            editWikiModel = new();

        StateHasChanged();
        info = "";
    }
}
