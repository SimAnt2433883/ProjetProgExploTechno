@page "/Inscription"
@rendermode InteractiveServer
@inject InscriptionService inscriptionService
@inject CustomAuthenticationStateProvider authProvider
@inject NavigationManager navManager
@using Prog3A25_AntoineTommy_Blazor.Authentication
@using Models
@using Services

<title>Inscription</title>

<div class="d-flex flex-column justify-content-center align-items-center vh-100" style="margin-top: -80px;">
    <h1 class="mb-4">Inscription</h1>
    <div class="card shadow p-4" style="min-width: 350px;">
        <EditForm Model="@inscriptionModel" FormName="InscriptionForm" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label class="form-label">Nom d'utilisateur</label>
                <InputText class="form-control" @bind-Value="inscriptionModel.Nom" placeholder="Nom d'utilisateur..." />
            </div>
            <div class="mb-3">
                <label class="form-label">Adresse email</label>
                <InputText type="email" class="form-control" @bind-Value="inscriptionModel.Email" placeholder="Email..." />
            </div>
            <div class="mb-3">
                <label for="exampleInputPassword1" class="form-label">Mot de passe</label>
                <InputText type="password" class="form-control" @bind-value="inscriptionModel.MotPasse" placeholder="Mot de passe..." />
            </div>
            <div class="buttons d-flex gap-2">
                <a href="/" class="btn btn-outline-secondary flex-fill">Se connecter</a>
                <button type="submit" class="btn btn-primary flex-fill">Soumettre</button>
            </div>
        </EditForm>
        @((MarkupString)message)
    </div>
</div>

@code {
    private InscriptionModel inscriptionModel = new InscriptionModel();
    private string? message;

    private async Task HandleSubmit()
    {
        Utilisateur utilisateur = await inscriptionService.InscrireUtilisateur(inscriptionModel.Email, inscriptionModel.Nom, inscriptionModel.MotPasse);

        if (utilisateur != null)
        {
            await authProvider.UpdateAuthenticationState(new UserSession(
                utilisateur.Nom,
                utilisateur.Administrateur ? "Administrateur" : "Normal",
                utilisateur.NoUtilisateur,
                utilisateur.NoPlante,
                utilisateur.Email
            ));
            navManager.NavigateTo("/CreationWiki");
        }
        else
        {
            message = "<p class='alert alert-danger mt-3'>Information(s) manquante(s)</p>";
        }
    }
}
