@page "/Wiki"
@using Microsoft.AspNetCore.Components.Authorization
@using Models
@using Services
@inject WikiService wikiService
@inject AuthenticationStateProvider authStateProvider
@rendermode InteractiveServer


<div class="container mt-5" style="max-width: 900px; margin: auto;">
    <h1 class="mb-4">Wiki</h1>

    <!-- SECTION RECHERCHE + RÉINITIALISER -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <!-- Recherche texte -->
                <div class="col-12">
                    <label class="form-label fw-bold">Rechercher une plante :</label>
                    <input class="form-control"
                           placeholder="Nom, description..."
                           value="@rechercheTexte"
                           @oninput="OnRechercheChange" />
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION FILTRES + BOUTON FILTRER -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <h5 class="fw-bold mb-3">Filtres avancés</h5>

            <div class="row g-3">

                <!-- Température -->
                <div class="col-md-4">
                    <label class="form-label">🌡 Température (°C)</label>
                    <InputNumber class="form-control"
                                 @bind-Value="filtreWiki.Temperature"
                                 min="-99" max="99" />
                </div>

                <!-- Humidité -->
                <div class="col-md-4">
                    <label class="form-label">💧 Humidité (%)</label>
                    <InputNumber class="form-control"
                                 @bind-Value="filtreWiki.Humidite"
                                 min="0" max="99" />
                </div>

                <!-- Rayons UV -->
                <div class="col-md-4">
                    <label class="form-label">☀ UV</label>
                    <InputNumber class="form-control"
                                 @bind-Value="filtreWiki.RayonsUV"
                                 min="0" max="99" />
                </div>

                <div class="col-12 d-flex justify-content-between mt-2">
                    <!-- Bouton Filtrer à gauche -->
                    <button class="btn btn-primary" @onclick="AppliquerFiltre">
                        Filtrer
                    </button>

                    <!-- Bouton Réinitialiser à droite -->
                    <button class="btn btn-secondary" @onclick="Reinitialiser">
                        Réinitialiser tout
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- PAGINATION -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-primary" @onclick="() => ChangePage(-1)">Précédent</button>
        <span class="fw-bold">Page @pageModel.IndexPage / @pageModel.PagesTotales</span>
        <button class="btn btn-outline-primary" @onclick="() => ChangePage(1)">Suivant</button>
    </div>

    <!-- LISTE DES PLANTES -->
    <div class="row">
        @foreach (var wiki in wikisPage)
        {
            <WikiCard wiki="@wiki" role="@role" />
        }
    </div>
</div>

@code {
    List<Models.Wiki> wikis = new(); // Liste de tous les wikis 
    List<Models.Wiki> wikisFiltres = new(); // Liste des wikis filtrés 
    List<Models.Wiki> wikisPage = new(); // Liste des wikis dans la page actuelle 

    FiltreWiki filtreWiki = new(); // Modèle avec les données de filtrage 
    string rechercheTexte = ""; // Texte dans la barre de recherche 

    string role = ""; // Role du user 

    PageModel pageModel = new() // Pour la pagination
    {
        IndexPage = 1,
        TaillePage = 5,
        PagesTotales = 1
    };

    protected override async Task OnInitializedAsync()
    {
        role = await wikiService.GetRole(authStateProvider);
        wikis = await wikiService.GetWikis();
        wikisFiltres = wikis;

        UpdatePage();
    }

    private void OnRechercheChange(ChangeEventArgs e)
    {
        rechercheTexte = e.Value?.ToString() ?? "";
        wikisFiltres = wikiService.Rechercher(wikis, rechercheTexte);
        pageModel.IndexPage = 1;

        UpdatePage();
    }

    private async Task AppliquerFiltre()
    {
        List<Models.Wiki> filtres = await wikiService.GetWikisFiltres(filtreWiki);
        wikisFiltres = wikiService.Rechercher(filtres, rechercheTexte);

        pageModel.IndexPage = 1;
        UpdatePage();
    }

    private void Reinitialiser()
    {
        filtreWiki = new();
        rechercheTexte = "";
        wikisFiltres = wikis;

        pageModel.IndexPage = 1;
        UpdatePage();
    }

    private void UpdatePage()
    {
        pageModel.PagesTotales = wikiService.GetNbPages(wikisFiltres, pageModel);
        pageModel.IndexPage = wikiService.CheckPage(pageModel);
        
        wikisPage = wikiService.FiltrerWikis(pageModel, wikisFiltres);

        StateHasChanged();
    }


    private void ChangePage(int changement)
    {
        pageModel.IndexPage = wikiService.UpdateIndexPage(changement, pageModel.PagesTotales, pageModel.IndexPage);

        UpdatePage();
    }
}
